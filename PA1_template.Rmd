---
title: '`Course Project 1` Reproducible Research'
author: '`r if(knitr::is_html_output()) {"&#x1f468;&#x1F3FB;&#x200d;&#x1f4bb; Anderson H Uyekita"} else {NULL}`'
output:
  html_document:
    keep_md: true
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
      smooth_scroll: true
  github_document: default
params:
  author: "Anderson H Uyekita"
  course: "Reproducible Research"
  course_url: "https://www.coursera.org/learn/reproducible-research"
  specialization: "Data Science: Foundations using R Specialization"
  specialization_url: "https://www.coursera.org/specializations/data-science-foundations-r"
  instructor: "Roger D Peng"
  course_start: !r lubridate::ymd("2022/06/23")
  course_finish: !r lubridate::today()
  week: "Week 2"
  slug: 'Week%202'
  rpubs: 'https://rpubs.com/AndersonUyekita/course-project-1_reproducible-research'
  project_repo: 'https://github.com/AndersonUyekita/reproducible-research_course-project-1'
  codebook: 'https://github.com/AndersonUyekita/reproducible-research_course-project-1/blob/master/codebook.md'
  instructions: 'https://github.com/AndersonUyekita/reproducible-research_course-project-1/blob/master/instructions.md'
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,cache=TRUE,message=FALSE,warning=FALSE)
library(rmarkdown)

# Force results to be in English
Sys.setlocale("LC_ALL","English")
```

`r if(!knitr::is_html_output()) {sprintf(fmt = "* &#x1f468;&#x1F3FB;&#x200d;&#x1f4bb; Author: %s", params$author)}`
`r sprintf(fmt = "* &#x1f4da; Specialization: [%s](%s){target='_blank' rel='noopener'}", params$specialization, params$specialization_url)`
`r sprintf(fmt = "* &#x1f4d6; Course: [%s](%s){target='_blank' rel='noopener'}", params$course, params$course_url)`
    `r sprintf(fmt = "* &#x1F9D1;&#x200d;&#x1F3EB; Instructor: %s", params$instructor)`
`r sprintf(fmt = "* &#x1F4C6; %s", params$week)`
    `r sprintf(fmt = "* &#x1F6A6; Start: %s", format(params$course_start, "%A, %d %B %Y"))`
    `r sprintf(fmt = "* &#x1F3C1; Finish: %s", format(params$course_finish, "%A, %d %B %Y"))`
`r if(!knitr::is_html_output()) {sprintf(fmt = "* &#x1F30E; Rpubs: [Interactive Document](%s)", params$rpubs)}else{sprintf(fmt = "* &#x1F4E6; Github Repository: [Static Document](%s){target='_blank' rel='noopener'}", params$project_repo)}`

--------------------------------------------------------------------------------

## Sinopsis


--------------------------------------------------------------------------------

## Course Project 1

The Course Project 1 solution has five sections:

1. Loading and pre-processing the data;
2. What is mean total number of steps taken per day?;
3. What is the average daily activity pattern?;
4. Imputing missing values;
5. Are there differences in activity patterns between weekdays and weekends?.

**Packages Requirements**

It is necessary to install the following packages to reproduce this Course Project 2.

```{r packages, echo = TRUE, warning=FALSE,message=FALSE,warning=FALSE}
# Loading libraries
library(ggplot2)
library(tidyverse)
library(magrittr)
library(kableExtra)
library(stringr)
library(lubridate)
```

Also, those following scripts will use the standard packages from R.

1. base
2. graphic
3. utils
4. grDevices

### 1. Loading and preprocessing the data

I have moved the `activity.zip`file to the data folder to make the repository root tidier.

#### 1.1. Load the data

```{r loadingdata,echo=TRUE,warning=FALSE,message=FALSE,warning=FALSE}
# Unzipping the compressed file
utils::unzip(zipfile = "./data/activity.zip",
             overwrite = TRUE,
             exdir = "./data/unzipped",
             list = FALSE)

# Loading the .csv file
raw_dataset <- utils::read.csv(file = "./data/unzipped/activity.csv",
                               header = TRUE)
```

Following the principles of Exploratory Data Analysis, let's dig into this dataset to analyze if it is necessary to make any adjustments. The first step is to know how many observations and variables this dataset has.

```{r dataset-dim, echo = TRUE}
# Printing the dimensions.
base::dim(raw_dataset) # Rows Columns
```

The database has 17.568 observations and 3 variables. It is aligned with the Course Project 1 instructions.

Now, I will check those variables because, according to the assignment instruction, those variables should be steps, date, and interval.

```{r dataset-variables, echo = TRUE}
# Print the column names.
base::colnames(raw_dataset)
```

The dataset has the expected variables and observations.

#### 1.2. Preprocessing the data

Initially, I will display the dataset summary (`summary()`) and then the structure (`str()`). It is necessary to have a big picture of the data in each variable because some data could be missing or wrongly classified/imported.

```{r exploratory,echo=TRUE}
# Printing the summary of each variables
summary(raw_dataset)

# Printing the dataset structure.
str(raw_dataset)
```

As warned by the Course Project 1 instructions, the `steps` variable has 2304 `NA` and is classified as an integer, the `date` variable is wrongly imported as "character", and the `interval` has no `NA` and is classified as an integer.

It is necessary two steps:

1. Removing any observation with `NA`, and;
2. Converting the `date` column into a date class.

```{r tidying,echo=TRUE}
# STEP 1 - Removing observations with NA.
aux_dataset <- base::subset(x = raw_dataset, !base::is.na(raw_dataset$steps))

# STEP 2 - Converting date column to Date class
tidy_dataset <- aux_dataset %>%
    dplyr::mutate(date = base::as.Date(date))

# Tidy dataset dimensions
base::dim(tidy_dataset)
```

The tidy dataset has 15.264 observations with the same 3 variables.

```{r checking-data-manipulation,echo=TRUE}
# Printing the summary of each variables
summary(tidy_dataset)

# Printing the dataset structure.
str(tidy_dataset)
```

The `interval` variable is recorded weirdly because each observation has a length of 4. The first two characters represent the hour and the last two the minutes. I will convert this column into a period class from `lubridate` package.

```{r fixing-interval-2-period,echo=TRUE}
# Converting interval into Period Class.
tidy_dataset <- tidy_dataset %>%
    mutate(interval = str_pad(interval, 4, pad = "0")) %>%
    mutate(interval = paste0(substr(interval, 1, 2),":",substr(interval, 3, 4),":00")) %>%
    mutate(interval = lubridate::hms(interval))
```

Finally, the tidy dataset has no `NA`, the date column is correctly classified as a Date class and interval variable is a "time" variable.

```{r,echo=TRUE}
# Presenting the tidy dataset first rows.
head(tidy_dataset) %>%
    kableExtra::kbl() %>%
    kableExtra::kable_styling()
```

### 2. What is mean total number of steps taken per day?

The `tidy_dataset` has lines corresponding to a sample of 5 minutes of the day. If everything is correct, each day must have 288 observations.

```{r checking-obs-per-day,echo=TRUE}
# Checking if each day has 288 observations.
tidy_dataset %>%
    dplyr::group_by(date) %>%
    dplyr::summarise(obs_day = dplyr::n()) %>%  # Count the number of observations per day.
    dplyr::select(obs_day) %>%
    unique() %>%
    as.numeric()
```

As you can see, all days have the same quantity of observations (288), allowing me to make further analyses using all observations of `tidy_dataset`.

#### 2.1. Calculate the total number of steps taken per day

Now, it is necessary to `aggregate` the rows of the same day to calculate a dataset based on days.

```{r aggregate-daily-steps,echo=TRUE}
# Calculating the number of steps in a day.
tidy_dataset_day <- tidy_dataset %>%
    dplyr::group_by(date) %>%
    dplyr::summarise(steps = sum(steps))

# ALTERNATIVE - Using the aggregate function
# tidy_dataset_day <- stats::aggregate(steps ~ date, data = tidy_dataset, FUN = sum)
```

According to the `tidy_dataset` there are 53 days in this dataset, so the `tidy_dataset_day` must have 53 rows.

```{r nrow-tidy-dataset,echo=TRUE}
# Number of rows
base::nrow(tidy_dataset_day)
```

The `tidy_dataset_day` has 53 observations and 2 columns (`date` and `steps`). The scatter plot below will show the distribution of daily steps between `r min(tidy_dataset_day$date)` and `r max(tidy_dataset_day$date)`.

```{r scatter-plot-per-day,echo=TRUE}
# Plotting a scatter plot using ggplot2.
ggplot2::ggplot(data = tidy_dataset_day,
                aes(x = date,
                    y = steps)) + 
    
    # Scatter plot
    geom_point() +
    
    # Adding Loess Regression 
    geom_smooth(formula = y ~ x,
                orientation = "x",
                method = 'loess',
                lwd = 0.75,
                aes(color = "Loess")) + 
    
    # Adding a horizontal line to show the Average
    geom_hline(yintercept = mean(tidy_dataset_day$steps),
               linetype = "dashed",
               color = "red",
               lwd = 1,
               aes(color = "Average")) +
    
    # Adding manually the legend.
    scale_color_manual(name = '',
                     breaks = c('Loess', 'Average'),
                     values = c('Loess' = 'blue', 'Average' = 'red')) + 
    
    # Defining the Plot title, x-axis label and y-axis label.
    labs(title = "Time Series of Steps") + 
    xlab(label = "Day") +
    ylab(label = "Daily Steps") +
    
    # Setting legend and title positions.
    theme(legend.position = "bottom",
          plot.title = element_text(hjust = 0.5))
```

#### 2.2. Make a histogram of the total number of steps taken each day

Based on `tidy_dataset_day`, the histogram below presents the daily steps habits.

```{r histogram-daily-steps,echo=TRUE}
# Plotting a ggplot2 histogram.
ggplot2::ggplot(data = tidy_dataset_day,
                aes(x = steps)) + 
    
    # Creating a histogram with 10 bins.
    geom_histogram(bins = 10) + 
    
    # Adding the Average
    geom_vline(xintercept = mean(tidy_dataset_day$steps),
               linetype = "dashed",
               color = "red",
               lwd = 1.0,
               aes(color = "Average")) + 
    
    # Defining the Plot title, x-axis label and y-axis label.
    labs(title = "Daily Steps Histogram") + 
    xlab(label = "Steps") +
    ylab(label = "Frequency") +
    
    # Setting legend and title positions.
    theme(legend.position = "right",
          plot.title = element_text(hjust = 0.5))
```

According to the above histogram, the most common daily steps varies between 10.000 and 15.000 thousand steps.

#### 2.3. Calculate the mean and median of daily steps.

The `summary` show the mean and median of daily `steps`.

```{r summary_step, echo = TRUE}
# Summary of steps
summary(tidy_dataset_day) %>%
    kableExtra::kbl() %>%
    kableExtra::kable_styling()
```

Finally, the daily steps mean and median:

* Mean = `r format(mean(tidy_dataset_day$steps),digits = 1)`
* Median = `r format(median(tidy_dataset_day$steps),digits = 1)`

### 3. What is the average daily activity pattern?

The `interval` variable is responsible for tracking the daily activity pattern. For this reason, I will use it to create a new dataset of daily activity pattern.

```{r daily-pattern,echo=TRUE}
# Calculating the number of steps in a day.
tidy_dataset_day_pattern <- tidy_dataset %>%
    dplyr::group_by(interval) %>%
    dplyr::summarise(steps = mean(steps))

# ALTERNATIVE - Using the aggregate function
# tidy_dataset_day_pattern <- base::aggregate(steps ~ interval, data = tidy_dataset, FUN = sum)
```

Let's check how is the dataset after the average. I will display the last rows.

```{r ,echo=TRUE}
# Presenting the Daily Pattern last rows.
tail(tidy_dataset_day_pattern) %>%
    kableExtra::kbl() %>%
    kableExtra::kable_styling()
```

#### 3.1. Make a time series plot of the 5-minute interval (x-axis) and the average number of steps taken, averaged across all days (y-axis)

The line plot below presents the average daily steps in each interval.

```{r,echo=TRUE}

tidy_dataset_day_pattern %>%
    mutate(interval = hms::hms(interval)) %>%

ggplot(aes(x = interval, y = steps)) + 
    geom_rect(aes(xmin = -Inf,
                  xmax = hms::hms(lubridate::hms("06:00:00")),
                  ymin= -Inf,
                  ymax = Inf), fill = "lightblue", alpha = 0.015) + 
    
    geom_rect(aes(xmin = hms::hms(lubridate::hms("06:00:00")),
                  xmax = hms::hms(lubridate::hms("18:00:00")),
                  ymin= -Inf,
                  ymax = Inf), fill = "yellow", alpha = 0.015) +
    
    geom_rect(aes(xmin = hms::hms(lubridate::hms("18:00:00")),
                  xmax = Inf,
                  ymin= -Inf,
                  ymax = Inf), fill = "lightblue", alpha = 0.015) +   
    
    geom_line() + 
    geom_point() +
    scale_x_time(breaks = c(hms::hms(lubridate::hms("00:00:00")),
                                           hms::hms(lubridate::hms("06:00:00")),
                                           hms::hms(lubridate::hms("12:00:00")),
                                           hms::hms(lubridate::hms("18:00:00")),
                                           hms::hms(lubridate::hms("24:00:00")))) + 

    # Defining the Plot title, x-axis label and y-axis label.
    labs(title = "Time Serie of Daily Interval Steps Average") + 
    xlab(label = "Interval") +
    ylab(label = "Steps Average") +
    
    # Setting legend and title positions.
    theme(plot.title = element_text(hjust = 0.5))
```

The person tracked has an explicit behavior to wake up around 5 AM, between 7 AM and 10 AM has the peak of steps (maybe the commute to work), around mid-day another rise which could be the trajectory to lunch.

#### 3.2. Which 5-minute interval, on average across all the days in the dataset, contains the maximum number of steps?

Let's filter the `tidy_dataset_day_pattern` to obtain the highest steps average and find when it happens.

```{r}
# 
tidy_dataset_day_pattern %>%
    filter(steps == max(steps)) %>%
    kableExtra::kbl() %>%
    kableExtra::kable_styling()
```

The highest steps average is 206.17, and it occurs at 08:35 AM.

### 4. Imputing missing values




#### Calculate and report the total number of missing values in the dataset (i.e. the total number of rows with NAs) 

According to the `summary()`, the steps variables has 2304 `NA` observations.

```{r}
summary(raw_dataset)
```

```{r}
sum(is.na(raw_dataset$steps))
```

#### Devise a strategy for filling in all of the missing values in the dataset. The strategy does not need to be sophisticated. For example, you could use the mean/median for that day, or the mean for that 5-minute interval, etc.


```{r}
tidy_dataset_2 <- raw_dataset %>%
    dplyr::mutate(date = base::as.Date(date)) %>%
    mutate(weekday = weekdays(date)) %>%
    mutate(interval = str_pad(interval, 4, pad = "0")) %>%
    mutate(interval = paste0(substr(interval, 1, 2),":",substr(interval, 3, 4),":00")) %>%
    mutate(interval = hms::hms(lubridate::hms(interval)))

avg_weekday <- tidy_dataset_2 %>%
    group_by(weekday, interval) %>%
    summarise(average = mean(steps,na.rm = TRUE))

avg_weekday
```



#### Create a new dataset that is equal to the original dataset but with the missing data filled in.







```{r}

merge(x = tidy_dataset_2,y = avg_weekday,by = c("interval", "weekday")) %>%
    arrange(date) %>%
    mutate(steps = coalesce(steps,average)) -> fim

summary(fim)

```



#### Make a histogram of the total number of steps taken each day and Calculate and report the mean and median total number of steps taken per day. Do these values differ from the estimates from the first part of the assignment? What is the impact of imputing missing data on the estimates of the total daily number of steps?


```{r histogram-daily-steps-imputed,echo=TRUE}

fim %>% group_by(date) %>%
    summarise(steps = sum(steps)) -> fim_2


fim_2 %>%

# Plotting a ggplot2 histogram.
ggplot2::ggplot(aes(x = steps)) + 
    
    # Creating a histogram with 10 bins.
    geom_histogram(bins = 10) + 
    
    # Adding the Average
    geom_vline(xintercept = mean(fim_2$steps),
               linetype = "dashed",
               color = "red",
               lwd = 1.0,
               aes(color = "Average")) + 
    
    # Defining the Plot title, x-axis label and y-axis label.
    labs(title = "Daily Steps Histogram") + 
    xlab(label = "Steps") +
    ylab(label = "Frequency") +
    
    # Setting legend and title positions.
    theme(legend.position = "right",
          plot.title = element_text(hjust = 0.5))
```

```{r}
summary(fim_2)
```



### 5. Are there differences in activity patterns between weekdays and weekends?

#### 5.1. Create a new factor variable in the dataset with two levels – “weekday” and “weekend” indicating whether a given date is a weekday or weekend day.

```{r}

fim %>%
    mutate(day_type = case_when(
        weekday %in% c("Friday", "Saturday") ~ "Weekend",
        !(weekday %in% c("Friday", "Saturday")) ~ "Weekday"
    )) -> fim_3


```




#### 5.2. Make a panel plot containing a time series plot (i.e. \color{red}{\verb|type = "l"|}type = "l") of the 5-minute interval (x-axis) and the average number of steps taken, averaged across all weekday days or weekend days (y-axis). See the README file in the GitHub repository to see an example of what this plot should look like using simulated data.


```{r}

fim_3 %>% 
    group_by(interval, day_type) %>%
    summarise(steps = mean(steps)) %>%

ggplot(aes(x = interval, y = steps)) + 
    geom_point() + 
    geom_line() +
    facet_grid(rows = vars(day_type))

```